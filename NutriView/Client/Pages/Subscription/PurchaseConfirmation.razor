@page "/subscriptionpage/purchaseconfirmation/{id:int}"
@inject HttpClient _client
@inject NavigationManager _navManager
@using NutriView.Shared.Domain

<h3>Purchase Confirmation</h3>
<hr />


<style>
    .subscription-container {
        max-width: 600px;
        margin: auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .subscription-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .form-select {
        width: 100%;
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }

    .btn-success {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 4px;
        background-color: #28a745;
        color: white;
        cursor: pointer;
        font-size: 16px;
        margin-top: 20px;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    .loading-message {
        text-align: center;
        font-size: 18px;
    }
</style>

<div class="subscription-container">
    <h3 class="subscription-header">Purchase Confirmation</h3>
    @if (subscriptionInfo == null || customers == null)
    {
        <p class="loading-message">Loading subscription details...</p>
    }
    else
    {
        <div>
            <h2>@subscriptionInfo.SubTierName</h2>
            <p>@subscriptionInfo.SubDescription</p>
            <p>@subscriptionInfo.SubCost.ToString("C")</p>

            <select @bind="selectedCustomerId" class="form-select">
                <option value="">-- Select Customer --</option>
                @foreach (var customer in customers)
                {
                    <option value="@customer.Id">@customer.UserName</option>
                }
            </select>

            <button class="btn btn-success" @onclick="CompleteSubscription">
                Confirm Subscription
            </button>
        </div>
    }
</div>


@code {
    [Parameter]
    public int Id { get; set; }

    private SubscriptionInfo? subscriptionInfo;
    private List<Customer>? customers;
    private int selectedCustomerId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            subscriptionInfo = await _client.GetFromJsonAsync<SubscriptionInfo>($"{Endpoints.SubscriptionInfosEndpoint}/{Id}");
            customers = await _client.GetFromJsonAsync<List<Customer>>($"{Endpoints.CustomersEndpoint}");
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"An error occurred while fetching data: {ex.Message}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An unexpected error occurred: {ex.Message}");
        }
    }

    private async Task CompleteSubscription()
    {
        if (selectedCustomerId == 0)
        {
            Console.WriteLine("Please select a customer before confirming the subscription.");
            return;
        }

        // Here you would implement the logic to process the subscription for the selected customer.
        // This could involve creating a new subscription record in the database with the `SubscriptionId` and `selectedCustomerId`.

        Console.WriteLine($"Subscription {Id} confirmed for customer {selectedCustomerId}");

        // Redirect to a thank-you page or display a confirmation message.
        _navManager.NavigateTo($"/thank-you");
    }
}